---
title: "Sintomatología depresiva en personas con Ideación Suicida: Un análisis de redes"
author: "Pablo Ezequiel Flores Kanter, Berenice Piceda, Sol Gomez"
date: "9/1/2021"
output:
  html_document:
    code_folding: show
    theme: paper
    highlight: pygments
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(magrittr)
```

## Resumen
1. Descripción general de la muestra y datos recolectados.
El trabajo se realizará en base a datos sobre sintomatología depresiva a partir de una muestra online de 4900 sujetos. Los datos de los distintos síntomas depresivos han sido obtenidos a partir de la aplicación de la escala Patient Health Questionnaire 9 (PHQ-9), un instrumento estandarizado de autoreporte que indaga sobre nueve síntomas depresivos diferentes. Para ello el instrumento se basa en los criterios diagnóstico diagnóstico para el Trastorno Depresivo Mayor que establece el Manual Diagnóstico y Estadístico de Trastornos Mentales en su quinta edición (DSM-V). La escala chequea la presencia de los siguientes síntomas en las pasadas últimas dos semanas: 1) ánimo deprimido; 2) anhedonia; 3) alteraciones en el sueño; 4) cansancio; 5) alteraciones en el apetito o en el peso; 6) sentimientos de culpa o inutilidad; 7) dificultades para concentrarse; 8) sentimientos de lentitud o preocupación; y 9) ideación suicida. Los ítems se responden en una escala de Likert desde 1 (nunca) a 5 (casi todos los días).  

2. Análisis descriptivos.







2. Estimación de modelos de redes.
El principal objetivo de éste trabajo es analizar cómo correlacionan los distíntos síntomas depresivos mencionados (sintomas del 1 (ánimo depresivo) al 8 (sentimientos de lentitud o preocupación)) en función de la variable ideaicón suicida (que se evalúa a partir del síntoma 9 de la escala PHQ-9). Para este objetivo se estimarán modelos de redes denominadas Markov random field o redes no-direccionales (undirected network/undirected graphical model) en dos grupos extremos de participantes distribuidos en base al item 9 de ideación suicida. Para esto se aplica un modelo de redes denominado Gaussian graphical model (GGM). En GGM cada elemento de la matriz de covarianza inversa corresponde a una conección (edge, aristas) en la red, la cual vincula dos variables (nodes, nodos) si se evidencia una interacción. Las aristas se estandarizan como coeficientes de correlación parcial entre dos variables luego de condicionarlas al resto de las variables del dataset. Con el objetivo de minimizar los errores estándares así como la inestabilidad de los parámetros estimados debido al overfitting (particularmente en muestras pequeñas), es que, en lugar de estimar la GGM directamente invirtiendo la matriz de varianza-covarianza, el modelo se estima utilizando Least Absolute Shrinkage and Selection Operator (LASSO). A los fines de comparar las redes entre los grupos extremos de interés es que se consideran las siguientes medidas de invarianza: invarianza estructural (network structure invariance), invarianza en la fuerza global de las correlaciones (global strength invariance), e invarianza al nivel de las correlaciones parciales entre dos nodos dados (edge invariance). En cada una de estas se aplican pruebas de hipótesis basadas en permutaciones (permutation based hypothesis test) para verificar si se aprecian o no diferencias estadísticamente significativas en cada una de las medidas de invarianza. 


## Estructura de los datos
1. Análisis iniciales exploratorios: descriptivos y correlacionales.
Para el caso de los análisis iniciales descriptivos y de correlación con variables sociodemográficas de sexo y edad se trasnformó levemente la tabla:
A continuación se describen brevemente los datos y su estructura para este objetivo inicial de análisis (tidy data). 

- Cuántas variables tienen? Se tienen cuatro variables, las cuales son : Sexo, Edad, Preguntas (sintomatología, items del PHQ-9) y  Respuesta (las opciones de respuestas en escala likert).
- De qué tipo es cada variable? La variable "Sexo" puede ser int o boolean; "Edad" no tiene rango (int), "Preguntas" es un char y "Respuestas" es un int. Las variables "Preguntas" y "Respuestas" tienen un rango de 1 a 5.
- Cuántas observaciones? Se cuentan con 44181 observaciones, pero éstas se ven reducidas drásticamente al filtrarse los grupos principales, es decir, aquellos que estarían compuestos por las respuestas “1” (no ideación suicida) y “5” (ideación suicida). Es a éstas observaciones que se aplicará el análisis en base a la edad, al sexo, y a otras condiciones aún a definir. 

2. Estimación de modelos de redes.
Para este caso no fue pertinente llevar el dataset a un formato tidy similar al aplicado para los análisis iniciales. Esto es así debido a que cada síntoma depresivo se entiende como una variable diferente, que puede estar asociada con las restantes, pero que refiere a un atributo distintivo de la depresión. Más importante aún, el objetivo de la estimación de modelos de redes es verificar como estas distintas variables correlacionan entre sí, y si éstas correlaciones parciales entre ellas presentan alguna diferencia entre dos grupos independientes de participantes (aquellos con alta ideación suicida vs aquellos que no manifestaron ideación suicida). Por todo ello, en este caso se cuenta con 11 variables (edad, sexo, phq-1 al phq-8, y el item 9 del phq que sirve para generar los grupos extremos en esta variable referida a la ideación suicida). Sin embargo, para simplificar la base solo se consideró la variable de ideación suicida con los grupos ya generados (variable grupos extremos en el item 9 del phq, una variable nominal dicotómica, 0 = grupo no ideación suicida y 1 = grupo con ideación suicida) y los síntomas depresivos restantes (ítems 1 al 8 del PHQ-9, variables enteras con rango del 1 al 5). Esta base se denomina "phq.csv" en los análisis correspondientes, y contiene los datos de las 4909 observaciones. 

## ANALISIS EXPLORATORIO- Carga de la base de datos. 

```{r}
datos_totales <- read.csv("Base4900_on-line.csv", sep = ";", dec = ".", header = TRUE)

```

##Conversión de la tabla a tidy. Las preguntas ahora aparecen en una sola columna llamada "Preguntas", y los valores de respuesta aparecen en una columna asociada llamada "Respuestas".
#Cambie los nombres de las columnas para que no fueran tan largos. Quizas es mejor opcion renombrarlos a P1, P2, etc.. Pero no queria perder la referencia al sintoma de cada pregunta. Ahora tendriamos 4 variables (sexo, edad, pregunta, respuesta)

```{r}
datos_totales_Tidy <- datos_totales %>% pivot_longer(c(PocoInteres,SensacionDeDepresion, ProblemasDeSuenio, 
                                     SensacionDeCansancio, PocoApetito, SensacionDeFracaso, 
                                     ProblemasDeConcentracion, AccionarLento, PensamientosSuicidas),
                                   names_to = "Preguntas", values_to = "Respuestas") %>% drop_na()
```

#Renombra nombre de variable Sexo a "Femenino" y "Masculino"
```{r}
datos_totales_Tidy$Sexo <- factor(datos_totales_Tidy$Sexo, labels=c("Femenino", "Masculino"))
datos_totales_Tidy
```

#Grafico General. Que respuesta gana en cada pregunta.
```{r}
datos_totales_Tidy_Pregunta9 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "PensamientosSuicidas") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "9-PensamientosSuicidas")

datos_totales_Tidy_Pregunta8 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "AccionarLento") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "8-AccionarLento")

datos_totales_Tidy_Pregunta7 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "ProblemasDeConcentracion") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "7-ProblemasDeConcentracion")

datos_totales_Tidy_Pregunta6 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "SensacionDeFracaso") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "6-AccionarLento")

datos_totales_Tidy_Pregunta5 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "PocoApetito") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "5-PocoApetito")

datos_totales_Tidy_Pregunta4 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "SensacionDeCansancio") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "4-SensacionDeCansancio")

datos_totales_Tidy_Pregunta3 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "ProblemasDeSuenio") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "3-ProblemasDeSuenio")

datos_totales_Tidy_Pregunta2 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "SensacionDeDepresion") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "2-SensacionDeDepresion")

datos_totales_Tidy_Pregunta1 <- datos_totales_Tidy %>%
  arrange(Preguntas) %>% filter(Preguntas == "PocoInteres") %>%
  group_by(Respuestas) %>% 
  summarise(Cantidad_de_rtas = n()) %>%
  mutate(Sintoma = "1-PocoInteres")

respuestas_por_pregunta <- rbind(datos_totales_Tidy_Pregunta1) %>% 
  rbind(datos_totales_Tidy_Pregunta2) %>%
  rbind(datos_totales_Tidy_Pregunta3) %>%
  rbind(datos_totales_Tidy_Pregunta4) %>%
  rbind(datos_totales_Tidy_Pregunta5) %>%
  rbind(datos_totales_Tidy_Pregunta6) %>%
  rbind(datos_totales_Tidy_Pregunta7) %>%
  rbind(datos_totales_Tidy_Pregunta8) %>%
  rbind(datos_totales_Tidy_Pregunta9) %>%
  arrange(Sintoma)

respuestas_por_pregunta
  
respuestas_por_pregunta %>% ggplot(aes(x = Respuestas, y = Cantidad_de_rtas)) +
  geom_col(colour = "black", width = 0.5) +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Respuestas",
       y = "Cantidad de Respuestas",
       title = "Respuesta ganadora en cada pregunta") + 
  theme_minimal() +
  facet_grid(. ~ Sintoma)
  
```

#Filtro para PensamientosSuicidas ordenados de menor a mayor en funcion de las edades 
```{r}
pensamiento_suicida <- datos_totales_Tidy %>% filter(Preguntas == "PensamientosSuicidas") %>%
  arrange(Edad)

pensamiento_suicida
```

#Filtro para pensamiento suicida con respuesta 1. Sin ordenar

```{r}
pensamiento_suicida_1 <- pensamiento_suicida %>% filter(Respuestas == "1")
pensamiento_suicida_1
 
```

#Filtro para pensamiento suicida con respuesta 5. Sin ordenar
```{r}
pensamiento_suicida_5 <- pensamiento_suicida %>% filter(Respuestas == "5")
pensamiento_suicida_5

```

#GRAFICOS -Instancia exploratoria v1#
#grafico pensamientos suicidas 1 en funcion del sexo 
```{r}
pensamiento_suicida_1 %>% ggplot(aes(x = Sexo, y = Respuestas)) + 
  geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Sexo",
       y = "Cantidad de respuestas",
       title = "Respuesta según género -Grupo no ideación suicida") + theme_minimal()
```

#grafico pensamientos suicidas 1 en funcion de la edad
```{r}
pensamiento_suicida_1 %>% ggplot(aes(x = Edad, y = Respuestas)) +
geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Edad",
       y = "Cantidad de respuestas",
       title = "Respuesta según edad -Grupo no ideación suicida") + theme_minimal()
```

#grafico pensamientos suicidas 5 en funcion del sexo 
```{r}
pensamiento_suicida_5 %>% ggplot(aes(x = Sexo, y = Respuestas)) + 
  geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Sexo",
       y = "Cantidad de respuestas",
       title = "Respuesta según género -Grupo ideación suicida") + theme_minimal()
```

#grafico pensamientos suicidas 5 en funcion de la edad
```{r}
pensamiento_suicida_5 %>% ggplot(aes(x = Edad, y = Respuestas)) + 
geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Edad",
       y = "Cantidad de respuestas",
       title = "Respuesta según edad -Grupo ideación suicida") + theme_minimal()
```

#Grafico general. Comparacion entre sexo y edad de los participantes.
```{r}
pensamiento_suicida %>% ggplot(aes(x = Sexo, y = Edad)) + 
  geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Sexo",
       y = "Edad",
       title = "Relación entre sexo y edad- general") + theme_minimal()

#está sumando las respuestas en vez de separarlo por valores?
```



## -------------------------------------------------------------------------------
## ESTIMACION Y COMPARACIÓN DE LOS MODELOS DE REDES

## 1.  Correr Librerias

```{r}
library("ggplot2")
library("qgraph")
library("bootnet")
library("psychonetrics")
library("NetworkComparisonTest")
library("EstimateGroupNetwork")
library("dplyr")
```

## 2.  Bases de Datos 


```{r}
Base <- read.csv("phq.csv", sep = ";", dec = ".", header = TRUE)


suicide <- Base[Base$Suicide_extrem == 1, ]
non_suicide <- Base[Base$Suicide_extrem == 0, ]

data_suicide <- suicide[2:9]
data_nonsuicide <- non_suicide[2:9]

data_suicide<- na.omit(data_suicide)
data_nonsuicide<- na.omit(data_nonsuicide)


```

## 3.  Estimacion de Redes 


```{r}
Network_suicide <- estimateNetwork(data_suicide,
                                 default = "EBICglasso",
                                 corMethod = "spearman")
Network_non_suicide <- estimateNetwork(data_nonsuicide,
                                   default = "EBICglasso",
                                   corMethod = "spearman")

L <- averageLayout(Network_suicide, Network_non_suicide)
Max <- max(abs(c(getWmat(Network_suicide), getWmat(Network_non_suicide))))
layout(t(1:2))
plot(Network_suicide, layout = L, title = "Suicide", maximum = Max)
plot(Network_non_suicide, layout = L, title = "Non Suicide", maximum = Max)

Network_suicide2 <- estimateNetwork(data_suicide2,
                                 default = "EBICglasso",
                                 corMethod = "spearman")
Network_non_suicide2 <- estimateNetwork(data_nonsuicide2,
                                   default = "EBICglasso",
                                   corMethod = "spearman")

L <- averageLayout(Network_suicide2, Network_non_suicide2)
Max <- max(abs(c(getWmat(Network_suicide2), getWmat(Network_non_suicide2))))
layout(t(1:2))
plot(Network_suicide2, layout = L, title = "Suicide", maximum = Max)
plot(Network_non_suicide2, layout = L, title = "Non Suicide", maximum = Max)

```
## 4. Test de Comparación de Redes


```{r}
set.seed(1)
NCTres <- NCT(data_suicide, data_nonsuicide, 
              it=100,
              test.edges = TRUE,
              progressbar= FALSE,
              edges = "all",
              p.adjust.methods = "bonferroni")

summary(NCTres)

NCTres$einv.pvals[which(NCTres$einv.pvals[,3] < 0.05), ]

```