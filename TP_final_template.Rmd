---
title: "Sintomatología depresiva en personas con Ideación Suicida: Un análisis de redes"
author: "Ezequiel Franco, Berenice Piceda, Sol Gomez"
date: "9/1/2021"
output:
  html_document:
    code_folding: show
    theme: paper
    highlight: pygments
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(magrittr)
```

## Resumen
El trabajo se realizará en base a datos sobre sintomatología depresiva de 4900 sujetos. Éstos fueron recopilados mediante un cuestionario de autoinforme conformado por 9 preguntas, permitiendo que fueran respondidas con un rango de números del 1 al 5.

El principal objetivo de éste trabajo es aplicar análisis de redes de síntomas depresivos, comparando dos grupos principales, ideación suicida vs no ideación suicida, permitiendo así estudiar las correlaciones entre ambos.

Por otra parte, se buscará analizar las relaciones entre las cuatro variables incluidas (sexo, edad, pregunta, respuesta) para comprobar si hay vínculos destacables entre las mismas.
Se cuentan con 44181 observaciones, pero éstas se ven reducidas drásticamente al filtrarse los grupos principales, es decir, aquellos que estarían compuestos por las respuestas “1” (no ideación suicida) y “5” (ideación suicida). Es a éstas observaciones que se aplicará el análisis en base a la edad, al sexo, y a otras condiciones aún a definir. 

## Estructura de los datos

Describir brevemente los datos (tidy data): 

- Cuántas variables tienen? Se tienen cuatro variables, las cuales son : Sexo, Edad, Pregunta y  Respuesta
- De qué tipo es cada variable? La variable "Sexo" puede ser int o boolean; "Edad" no tiene rango (int), "Preguntas" es un char y "Respuestas" es un int. Las variables "Preguntas" y "Respuestas" tienen un rango de 1 a 5.
- Cuántas observaciones? En total se poseen 44181 observaciones cuando los datos se convierten a formato tidy, pero si nos limitamos a aquellas relativas al pensamiento suicida restan 4909 observaciones.


## ANALISIS EXPLORATORIO- Carga de la base de datos. 

```{r}
datos_totales <- read.csv("Base4900_on-line.csv", sep = ";", dec = ".", header = TRUE)

```

##Conversión de la tabla a tidy. Las preguntas ahora aparecen en una sola columna llamada "Preguntas", y los valores de respuesta aparecen en una columna asociada llamada "Respuestas".
#Cambie los nombres de las columnas para que no fueran tan largos. Quizas es mejor opcion renombrarlos a P1, P2, etc.. Pero no queria perder la referencia al sintoma de cada pregunta. Ahora tendriamos 4 variables (sexo, edad, pregunta, respuesta)

```{r}
datos_totales_Tidy <- datos_totales %>% pivot_longer(c(PocoInteres,SensacionDeDepresion, ProblemasDeSuenio, 
                                     SensacionDeCansancio, PocoApetito, SensacionDeFracaso, 
                                     ProblemasDeConcentracion, AccionarLento, PensamientosSuicidas),
                                   names_to = "Preguntas", values_to = "Respuestas") %>% drop_na()
```

#Filtro para PensamientosSuicidas ordenados de menor a mayor en funcion de las respuestas 

```{r}
pensamiento_suicida <- datos_totales_Tidy %>% filter(Preguntas == "PensamientosSuicidas") %>%
  arrange(Respuestas)

pensamiento_suicida
```
#Filtro para pensamiento suicida con respuesta 1. Sin ordenar

```{r}
pensamiento_suicida_1 <- pensamiento_suicida %>% filter(Respuestas == "1")

 
```

#Filtro para pensamiento suicida con respuesta 5. Sin ordenar
```{r}
pensamiento_suicida_5 <- pensamiento_suicida %>% filter(Respuestas == "5")

```


#GRAFICOS -Instancia exploratoria v1#
#grafico pensamientos suicidas 1 en funcion del sexo 
```{r}
pensamiento_suicida_1 %>% ggplot(aes(x = Sexo, y = Respuestas)) + 
  geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Sexo",
       y = "Cantidad de respuestas",
       title = "Respuesta según género -Grupo no ideación suicida") + theme_minimal()

#habría que cambiar "1" y "2" por "fem" y "masc"
```

#grafico pensamientos suicidas 1 en funcion de la edad
```{r}
pensamiento_suicida_1 %>% ggplot(aes(x = Edad, y = Respuestas)) +
geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Edad",
       y = "Cantidad de respuestas",
       title = "Respuesta según edad -Grupo no ideación suicida") + theme_minimal()
```

#grafico pensamientos suicidas 5 en funcion del sexo 
```{r}
pensamiento_suicida_5 %>% ggplot(aes(x = Sexo, y = Respuestas)) + 
  geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Sexo",
       y = "Cantidad de respuestas",
       title = "Respuesta según género -Grupo ideación suicida") + theme_minimal()
```

#grafico pensamientos suicidas 5 en funcion de la edad
```{r}
pensamiento_suicida_5 %>% ggplot(aes(x = Edad, y = Respuestas)) + 
geom_col(colour = "black",
           fill = "#1380A1",
           width = 0.5) +
  labs(x = "Edad",
       y = "Cantidad de respuestas",
       title = "Respuesta según edad -Grupo ideación suicida") + theme_minimal()
```

#pendiente grafico gral comparacion entre sexo y edad de los participantes



## PRUEBAS INICIALES TIDYVERSE

## 1.  Correr Librerias

```{r}
library("ggplot2")
library("qgraph")
library("bootnet")
library("psychonetrics")
library("NetworkComparisonTest")
library("EstimateGroupNetwork")
library("dplyr")
library("scales")

```

## 2.  Bases de Datos 
## 2.1. BDI-II

```{r}
Base <- read.csv("phq.csv", sep = ";", dec = ".", header = TRUE)


suicide <- Base[Base$Suicide_extrem == 1, ]
non_suicide <- Base[Base$Suicide_extrem == 0, ]

data_suicide <- suicide[3:10]
data_nonsuicide <- non_suicide[3:10]

suicide2 <- Base[Base$Suicide_extrem2 == 1, ]
non_suicide2 <- Base[Base$Suicide_extrem2 == 0, ]

data_suicide2 <- suicide2[3:10]
data_nonsuicide2 <- non_suicide2[3:10]

data_suicide2<- na.omit(data_suicide2)
data_nonsuicide2<- na.omit(data_nonsuicide2)

data_suicide<- na.omit(data_suicide)
data_nonsuicide<- na.omit(data_nonsuicide)


```
## 3.  Estimacion de Redes 
## 3.1. BDI-II

```{r}
Network_suicide <- estimateNetwork(data_suicide,
                                 default = "EBICglasso",
                                 corMethod = "spearman")
Network_non_suicide <- estimateNetwork(data_nonsuicide,
                                   default = "EBICglasso",
                                   corMethod = "spearman")

L <- averageLayout(Network_suicide, Network_non_suicide)
Max <- max(abs(c(getWmat(Network_suicide), getWmat(Network_non_suicide))))
layout(t(1:2))
plot(Network_suicide, layout = L, title = "Suicide", maximum = Max)
plot(Network_non_suicide, layout = L, title = "Non Suicide", maximum = Max)

Network_suicide2 <- estimateNetwork(data_suicide2,
                                 default = "EBICglasso",
                                 corMethod = "spearman")
Network_non_suicide2 <- estimateNetwork(data_nonsuicide2,
                                   default = "EBICglasso",
                                   corMethod = "spearman")

L <- averageLayout(Network_suicide2, Network_non_suicide2)
Max <- max(abs(c(getWmat(Network_suicide2), getWmat(Network_non_suicide2))))
layout(t(1:2))
plot(Network_suicide2, layout = L, title = "Suicide", maximum = Max)
plot(Network_non_suicide2, layout = L, title = "Non Suicide", maximum = Max)

```
## 4. Test de Comparación de Redes
## 4.1.1 BDI-II: NCT

```{r}
set.seed(1)
NCTres <- NCT(data_suicide, data_nonsuicide, 
              it=100,
              test.edges = TRUE,
              progressbar= FALSE,
              edges = "all",
              p.adjust.methods = "bonferroni")

summary(NCTres)

NCTres$einv.pvals[which(NCTres$einv.pvals[,3] < 0.05), ]

```
